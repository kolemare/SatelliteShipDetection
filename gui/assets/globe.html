<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>AOI Globe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Local Leaflet core -->
    <link rel="stylesheet" href="./vendor/leaflet.css" />
    <script src="./vendor/leaflet.js"></script>

    <!-- Local Leaflet.draw -->
    <link rel="stylesheet" href="./vendor/leaflet.draw.css" />
    <script src="./vendor/leaflet.draw.js"></script>

    <!-- Our style -->
    <link rel="stylesheet" href="style.css" />

    <!-- Qt WebChannel -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
</head>

<body>
    <div id="map"></div>

    <script>
        // Ensure Leaflet is loaded
        if (typeof L === "undefined") {
            document.body.innerHTML = "<h3 style='color:red;text-align:center;margin-top:2em'>‚ùå Leaflet failed to load. Check assets/vendor/leaflet.js</h3>";
            throw new Error("Leaflet not loaded");
        }

        // Init map
        var map = L.map('map').setView([20, 0], 2);

        // Base tiles (OpenStreetMap as default)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Draw controls
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: false,
                circle: false,
                circlemarker: false,
                marker: false,
                rectangle: true
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        function toBBox(layer) {
            var b = layer.getBounds();
            return {
                west: b.getWest(),
                south: b.getSouth(),
                east: b.getEast(),
                north: b.getNorth()
            };
        }

        // WebChannel bridge
        var bridge = null;
        new QWebChannel(qt.webChannelTransport, function (channel) {
            bridge = channel.objects.pyBridge;
        });

        // Handle rectangle draw
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            var layer = e.layer;
            drawnItems.addLayer(layer);

            var bbox = toBBox(layer);
            if (bridge) {
                bridge.postMessage(JSON.stringify({
                    type: "bbox",
                    west: bbox.west,
                    south: bbox.south,
                    east: bbox.east,
                    north: bbox.north
                }));
            }
        });
    </script>
</body>

</html>